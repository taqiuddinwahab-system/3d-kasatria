<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>3D Data - Table / Sphere / Double Helix / Grid</title>
<style>
  :root{--accent:#00ffff}
  body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
  #container{width:100vw;height:100vh;position:relative}
  #menu{position:fixed;left:0;right:0;bottom:18px;text-align:center;z-index:40}
  .btn{display:inline-block;margin:6px;padding:10px 14px;border:2px solid var(--accent);color:var(--accent);background:transparent;cursor:pointer;border-radius:4px;font-weight:600}
  .btn:hover{background:var(--accent);color:#000}
  .element{width:150px;height:200px;border-radius:10px;padding-top:10px;box-sizing:border-box;text-align:center;color:#fff;cursor:default;border:2px solid rgba(255,255,255,0.08)}
  .element img{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-top:6px}
  .name{font-weight:700;font-size:14px;margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .meta{font-size:12px;opacity:0.9;margin-top:6px}
  .worth{margin-top:8px;font-weight:700}
  #legend{position:fixed;left:12px;top:12px;background:rgba(0,0,0,0.5);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);font-size:13px;z-index:50}
  .legend-item{display:flex;gap:8px;align-items:center;margin:4px 0}
  .sw{width:18px;height:12px;border-radius:2px;border:1px solid rgba(0,0,0,0.2)}
  #status{position:fixed;right:12px;top:12px;background:rgba(0,0,0,0.5);padding:8px;border-radius:8px;font-size:13px;border:1px solid rgba(255,255,255,0.06);z-index:50}
</style>
</head>
<body>
<div id="container"></div>

<div id="legend">
  <div style="font-weight:700;margin-bottom:6px">Net Worth</div>
  <div class="legend-item"><div class="sw" style="background:#ef4444"></div> &lt; $100,000</div>
  <div class="legend-item"><div class="sw" style="background:#f59e0b"></div> $100,000–$199,999</div>
  <div class="legend-item"><div class="sw" style="background:#10b981"></div> ≥ $200,000</div>
</div>

<div id="status">Loading…</div>

<div id="menu">
  <button class="btn" id="btnTable">TABLE</button>
  <button class="btn" id="btnSphere">SPHERE</button>
  <button class="btn" id="btnHelix">DOUBLE HELIX</button>
  <button class="btn" id="btnGrid">GRID</button>
</div>

<!-- three.js import map (CDN) -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import TWEEN from 'three/addons/libs/tween.module.js';
import { TrackballControls } from 'three/addons/controls/TrackballControls.js';
import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

/* ========== CONFIG ========== */
const EXEC_URL = "https://script.google.com/macros/s/AKfycbxytY2qsin443LeUfX2-ICJN0-rEej_DdiIYO7r2VqJW8kAgxtYUVCz-Iq7vT9eTK6AhQ/exec";
const MAX_SLOTS = 200; // limit to 200 (20x10 / 5x4x10)
/* ============================ */

const container = document.getElementById('container');
const status = document.getElementById('status');

let camera, scene, renderer, controls;
const objects = [];
const targets = { table:[], sphere:[], helix:[], grid:[] };

async function start(){
  setStatus('Fetching data...');
  const rows = await fetchRows(EXEC_URL).catch(err => { setStatus('Fetch failed: ' + err.message); throw err; });
  setStatus('Normalizing data...');
  const data = normalize(rows);
  setStatus(`Building ${data.length} tiles...`);
  initScene();
  buildTiles(data);
  buildLayouts();
  bindControls();
  transform(targets.table, 1200);
  setStatus('');
  animate();
}

function setStatus(t){ status.textContent = t; }

/* ----- fetch rows from google script ----- */
async function fetchRows(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  const j = await res.json();
  return j;
}

/* ----- normalize rows to objects, first row may be header ----- */
function normalize(rows){
  if(!Array.isArray(rows)) return [];
  let start = 0;
  if(rows.length>0 && Array.isArray(rows[0])){
    const first = rows[0].map(c => (c||'').toString().toLowerCase());
    if(first.includes('name') || first.includes('photo')) start = 1;
  }
  const out = [];
  for(let i=start;i<rows.length && out.length<MAX_SLOTS;i++){
    const r = rows[i];
    const [Name, Photo, Age, Country, Interest, NetWorth] = [
      r[0] ?? '', r[1] ?? '', r[2] ?? '', r[3] ?? '', r[4] ?? '', r[5] ?? ''
    ];
    out.push({ Name: String(Name), Photo: String(Photo), Age: String(Age), Country: String(Country), Interest: String(Interest), NetWorth: String(NetWorth) });
  }
  return out;
}

/* ----- scene init ----- */
function initScene(){
  camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 1, 20000);
  camera.position.set(0,0,3000);
  scene = new THREE.Scene();

  renderer = new CSS3DRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  container.appendChild(renderer.domElement);

  controls = new TrackballControls(camera, renderer.domElement);
  controls.minDistance = 500;
  controls.maxDistance = 8000;
  controls.addEventListener('change', render);

  window.addEventListener('resize', onWindowResize);
}

/* ----- build tiles ----- */
function buildTiles(data){
  // clear old
  while(objects.length){ const o = objects.pop(); scene.remove(o); }
  targets.table.length = 0; targets.sphere.length = 0; targets.helix.length = 0; targets.grid.length = 0;

  for(let i=0;i<data.length;i++){
    const p = data[i];
    const el = document.createElement('div');
    el.className = 'element';

    // parse networth to number
    const net = parseFloat(String(p.NetWorth).replace(/[\$,()]/g,'').replace(/,/g,'')) || 0;

    if(net < 100000) el.style.background = '#ef4444';
    else if(net < 200000) el.style.background = '#f59e0b';
    else el.style.background = '#10b981';

    const photo = p.Photo ? `<img src="${escapeHtml(p.Photo)}" alt="" onerror="this.style.opacity=0.5">` : '';
    el.innerHTML = `
      ${photo}
      <div class="name">${escapeHtml(p.Name)}</div>
      <div class="meta">${escapeHtml(p.Age)} • ${escapeHtml(p.Country)}</div>
      <div class="meta">${escapeHtml(p.Interest)}</div>
      <div class="worth">${escapeHtml(p.NetWorth)}</div>
    `;

    const cssObj = new CSS3DObject(el);
    cssObj.position.x = Math.random()*4000 - 2000;
    cssObj.position.y = Math.random()*4000 - 2000;
    cssObj.position.z = Math.random()*4000 - 2000;

    scene.add(cssObj);
    objects.push(cssObj);

    // Table 20x10 positions
    const tableObj = new THREE.Object3D();
    const col = i % 20;
    const row = Math.floor(i / 20);
    tableObj.position.set((col * 160) - (160*10) + 80, -(row * 210) + (210*5) - 40, 0);
    targets.table.push(tableObj);
  }
}

/* ----- layouts ----- */
function buildLayouts(){
  buildSphere();
  buildDoubleHelix();
  buildGrid();
}

function buildSphere(){
  targets.sphere.length = 0;
  const vector = new THREE.Vector3();
  const l = objects.length;
  for(let i=0;i<l;i++){
    const phi = Math.acos(-1 + (2*i)/l);
    const theta = Math.sqrt(l * Math.PI) * phi;
    const obj = new THREE.Object3D();
    obj.position.setFromSphericalCoords(1100, phi, theta);
    vector.copy(obj.position).multiplyScalar(2);
    obj.lookAt(vector);
    targets.sphere.push(obj);
  }
}

function buildDoubleHelix(){
  targets.helix.length = 0;
  const radius = 900;
  const step = 9;
  for(let i=0;i<objects.length;i++){
    const theta = i * 0.25;
    const y = -i * step + (objects.length * step / 2);
    const offset = (i % 2 === 0) ? 0 : Math.PI;
    const obj = new THREE.Object3D();
    obj.position.set(Math.sin(theta + offset) * radius, y, Math.cos(theta + offset) * radius);
    obj.lookAt(new THREE.Vector3(0, y, 0));
    targets.helix.push(obj);
  }
}

function buildGrid(){
  targets.grid.length = 0;
  for(let i=0;i<objects.length;i++){
    const x = i % 5;
    const y = Math.floor(i / 5) % 4;
    const z = Math.floor(i / 20);
    const obj = new THREE.Object3D();
    obj.position.set((x * 320) - (320*2), (y * 260) - (260*1.5), (z * 700) - (700*4.5));
    targets.grid.push(obj);
  }
}

/* ----- transform animation ----- */
function transform(targetArr, duration=1000){
  TWEEN.removeAll();
  for(let i=0;i<objects.length;i++){
    const obj = objects[i];
    const t = targetArr[i];
    if(!t) continue;
    new TWEEN.Tween(obj.position)
      .to({ x: t.position.x, y: t.position.y, z: t.position.z }, duration + Math.random()*400)
      .easing(TWEEN.Easing.Exponential.InOut)
      .start();
    new TWEEN.Tween(obj.rotation)
      .to({ x:0, y:0, z:0 }, duration + Math.random()*400)
      .easing(TWEEN.Easing.Exponential.InOut)
      .start();
  }
  new TWEEN.Tween({}).to({}, duration+800).onUpdate(render).start();
}

/* ----- UI & loop ----- */
function bindControls(){
  document.getElementById('btnTable').onclick = ()=> transform(targets.table,1200);
  document.getElementById('btnSphere').onclick = ()=> transform(targets.sphere,1200);
  document.getElementById('btnHelix').onclick = ()=> transform(targets.helix,1200);
  document.getElementById('btnGrid').onclick = ()=> transform(targets.grid,1200);
}

function onWindowResize(){
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  render();
}

function render(){ renderer.render(scene, camera); }

function animate(){
  requestAnimationFrame(animate);
  TWEEN.update();
  controls.update();
  render();
}

/* safe HTML esc */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ----- kick off ----- */
(async ()=>{ 
  try{ await start(); } catch(e){ console.error(e); } 
})();

</script>
</body>
</html>
